### Работа с загрузчиком

### Цель:

Научиться попадать в систему без пароля;
Устанавливать систему с LVM и переименовывать в VG.

###  Задание:

1. Включить отображение меню Grub.
2. Попасть в систему без пароля несколькими способами.
3. Установить систему с LVM, после чего переименовать VG.


### Решение:


#### 1. Включить отображение меню Grub.

Для включения возможности отображения меню загрузчика GRUB необходимо отредактировать файл /etc/default/grub:


````
otus@otusadmin:~$ sudo -i
[sudo] password for otus:
root@otusadmin:~# nano /etc/default/grub
````

Комментируем GRUB_TIMEOUT_STYLE=hidden и устанавливаем время отображения в 10 сек:

````
#GRUB_TIMEOUT_STYLE=hidden
GRUB_TIMEOUT=10
````

Обновляем конфигурацию загрузчика и перезапускаем систему:

````
root@otusadmin:~# update-grub
root@otusadmin:~# reboot
````

Во время загрузки видим отображение загрузочного меню GRUB:

![](/Lab07_GRUB/pic/GRUB_menu.jpg)

#### 2. Попасть в систему без пароля несколькими способами.

* 1-ый способ. В меню загрузчика GRUB нажимаем 'e' и попадаем в окно с кодом загрузчика:

![](/Lab07_GRUB/pic/GRUB_params_e.jpg)

в строке, начинающейся с "linux" (или "kernel") добавляем строку запуска командой строки init=/bin/bash:

![](/Lab07_GRUB/pic/GRUB_bin_bash.jpg)

После этого продолжаем загрузку и система загружается под root`ом:

![](/Lab07_GRUB/pic/Root_access.jpg)

Следует учитывать, что на данном этапе система запущена в режиме файловой системы read only и изменить файлы не получится.

Cделаем монитрование FS с режимом rw:

![](/Lab07_GRUB/pic/remount_rw.jpg)

После чего можно, например, свободно записать и прочитать файл в системе: 

![](/Lab07_GRUB/pic/write_file_test.jpg)

* 2-ой способ.

В загрузчике GRUB выбираем пункт "Advanced options ..."

![](/Lab07_GRUB/pic/GRUB_advanced_options.jpg)

Выбираем нужное ядро с режимом "recovery":

![](/Lab07_GRUB/pic/GRUB_Recovery.jpg)

Первое, выбираем опцию "network", чтобы система смонтировала файловую систему в режиме rw: 

![](/Lab07_GRUB/pic/GRUB_recovery_network.jpg)

![](/Lab07_GRUB/pic/GRUB_recovery_network_query.jpg)

После этого выбираем "root": 

![](/Lab07_GRUB/pic/GRUB_recovery_root.jpg)

система стартует с консолью root`a:

![](/Lab07_GRUB/pic/GRUB_recovery_root_entered.jpg)


#### 3. Установить систему с LVM, после чего переименовать VG.

Выводим текущее состояние Volume Group:

````
root@otusadmin:~# vgs.
  VG        #PV #LV #SN Attr   VSize   VFree
  datavg      4   2   0 wz-pn-   3.98g <1.01g
  ubuntu-vg   1   1   0 wz--n- <38.00g 19.00g

````

Переименовываем VG с "ubuntu-vg" на "ubuntu-otus":

````
root@otusadmin:~# vgrename ubuntu-vg ubuntu-otus
  Volume group "ubuntu-vg" successfully renamed to "ubuntu-otus"

````

В методическом пособии предлагается внести изменения в файл /boot/grub/grub.cfg:

````
root@otusadmin:~# nano /boot/grub/grub.cfg

````
Однако, этот файл генерируется автоматически и его изменение не рекомендуется:

````
# DO NOT EDIT THIS FILE
#
# It is automatically generated by grub-mkconfig using templates
# from /etc/grub.d and settings from /etc/default/grub
````

Исследование вопроса(https://askubuntu.com/questions/765058/how-do-you-rename-the-volume-group-that-contains-the-root-volume-in-lvm) привело к выводу, что данное сообщение можно в данном случае проигнорировать и внести вручную изменения в данном файле в местах использования Volume Group:

````
menuentry 'Ubuntu' --class ubuntu --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-simple-7c2fe546-ec79-4ffa-93dd-338277c68c66'>
        recordfail
        load_video
        gfxmode $linux_gfx_mode
        insmod gzio
        if [ x$grub_platform = xxen ]; then insmod xzio; insmod lzopio; fi
        insmod part_gpt
        insmod ext2
        set root='hd0,gpt2'
        if [ x$feature_platform_search_hint = xy ]; then
          search --no-floppy --fs-uuid --set=root --hint-bios=hd0,gpt2 --hint-efi=hd0,gpt2 --hint-baremetal=ahci0,gpt2  cc4487bf-0e7b-4eb5-8fd8-7d1a60>
        else
          search --no-floppy --fs-uuid --set=root cc4487bf-0e7b-4eb5-8fd8-7d1a6084b12f
        fi
        linux   /vmlinuz-6.14.4-061404-generic root=/dev/mapper/ubuntu--otus-ubuntu--lv ro
        initrd  /initrd.img-6.14.4-061404-generic
````

Делаем для всех мест использования... 

Характерно, что сейчас (сразу после редактирования /boot/grub/grub.cfg) выполнение команды 'update-grub' невозможно - система ругается на невозможность найти пути к старому VG. 


Также перед перезагрузкой проверим файл /etc/fstab на предмет настроек относительно Volume Groups:
````
# /etc/fstab: static file system information.
#
# Use 'blkid' to print the universally unique identifier for a
# device; this may be used with UUID= as a more robust way to name devices
# that works even if disks are added and removed. See fstab(5).
#
# <file system> <mount point>   <type>  <options>       <dump>  <pass>
# / was on /dev/ubuntu-vg/ubuntu-lv during curtin installation
/dev/disk/by-id/dm-uuid-LVM-k7xceCwe4m61l1KX4bpS3m557XgmurSguP1J3IL9L7EDuhg4j3WQojLA5QUGBUYf / ext4 defaults 0 1
# /boot was on /dev/sda2 during curtin installation
/dev/disk/by-uuid/cc4487bf-0e7b-4eb5-8fd8-7d1a6084b12f /boot ext4 defaults 0 1
/swap.img       none    swap    sw      0       0

````

Тут видно, что монитрование LVM использует UUID идентификатор, которые не зависят от имени VG.


Далее перезагружаем систему, система загружается и после перезагрузки команда 'update-grub' срабатывает штатно:

````
root@otusadmin:~# update-grub
Sourcing file `/etc/default/grub'
Generating grub configuration file ...
  
Found linux image: /boot/vmlinuz-6.14.4-061404-generic
Found initrd image: /boot/initrd.img-6.14.4-061404-generic
Found linux image: /boot/vmlinuz-6.8.0-60-generic
Found initrd image: /boot/initrd.img-6.8.0-60-generic
Found linux image: /boot/vmlinuz-6.8.0-58-generic
Found initrd image: /boot/initrd.img-6.8.0-58-generic
Warning: os-prober will not be executed to detect other bootable partitions.
Systems on them will not be added to the GRUB boot configuration.
Check GRUB_DISABLE_OS_PROBER documentation entry.
Adding boot menu entry for UEFI Firmware Settings ...
done
````

Содержимое файла /boot/grub/grub.cfg после работы "update-grub" не поменялось в местах монитрования:

````
menuentry 'Ubuntu' --class ubuntu --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-simple-7c2fe546-ec79-4ffa-93dd-338277c68c66'>
        recordfail
        load_video
        gfxmode $linux_gfx_mode
        insmod gzio
        if [ x$grub_platform = xxen ]; then insmod xzio; insmod lzopio; fi
        insmod part_gpt
        insmod ext2
        set root='hd0,gpt2'
        if [ x$feature_platform_search_hint = xy ]; then
          search --no-floppy --fs-uuid --set=root --hint-bios=hd0,gpt2 --hint-efi=hd0,gpt2 --hint-baremetal=ahci0,gpt2  cc4487bf-0e7b-4eb5-8fd8-7d1a60>
        else
          search --no-floppy --fs-uuid --set=root cc4487bf-0e7b-4eb5-8fd8-7d1a6084b12f
        fi
        linux   /vmlinuz-6.14.4-061404-generic root=/dev/mapper/ubuntu--otus-ubuntu--lv ro
        initrd  /initrd.img-6.14.4-061404-generic

````

Т.е. на сейчас система работает корректно - VG переименован, система загружается и команды работают штатно.





